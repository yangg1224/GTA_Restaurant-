---
title: "TITLE"
author: "Adrian Wong, Yingying Zhou, Xinyi Xu, Yang Wu "
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
 bookdown::pdf_document2:
 toc: no
subtitle: "SUBTITLE"
abstract: "ABSTRACT"
thanks: 'Code and data are available at: https://github.com/yangg1224/groupproject-.git'
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
#install.packages("PerformanceAnalytics")
library("PerformanceAnalytics")
library(ggplot2)
library(kableExtra)
library(ggpubr)
```

# Introduction
```{r}

```

# Data 

## Intervention 

## Data Gathering Method 

## Descriptive Analysis
```{r read_data, include=FALSE}

setwd("~/Downloads/Git/groupproject-") 

# read raw dataset from scripts, need to run survey_response _simulation first.
simulated_data<- read_csv("inputs/simulated_data.csv") 

# We add a new column To distinguish the restaurant size by employees number. 
# if employees number >20 then we define it is big, otherwise it is small.
for (i in 1:nrow(simulated_data)){
  if ((simulated_data$Q8[i] == ">30") || (simulated_data$Q8[i] == "20-30")){
  simulated_data$size[i] = "Big"  
  }else {
    simulated_data$size[i] = "Small"
  }
}

treated_data<-
  filter(simulated_data, simulated_data$type == "Treated" ) # load treated data 

control_data<-
  filter(simulated_data, simulated_data$type == "Control" ) # load control data
```

```{r size,echo=FALSE}
# Get the number of rows
size<- nrow(simulated_data)
```

After discussing data gathering method, we sampled data in R [@citeR]. We totally have **`r size`** observations, and 14 of following features according to the questionnaires.

* `type` : Categorical identifier [“Treated” or “Control”] for each observation 
* `Q1` : First three digits of the postcode 
* `Q2` : Categorical identifier for distinguishing the type of restaurants 
* `Q3` : Region name in GTA
* `Q4` : Describe whether the restaurant is a franchise (“Franchise” or “No”)
* `Q5` : The length of the operation years for each restaurant 
* `Q6` : Describe whether the restaurant offer takeout service (“Yes” or “No”)
* `Q7` : Describe whether the restaurant offer delivery service (“Yes” or “No”)
* `Q8` : Number of employees in the restaurant (category type)
* `Q9` : Average employee hourly rate (CAD) 
* `Q10` : Describe whether the restaurant has been a site of a potential COVID case (“Yes” or “No”)
* `Q11` : Describe the restaurant’s fixed costs change situation 
* `Q12` :  Describe the restaurant’s flexible costs change situation 
* `Q13` : The restaurant’s past month revenue (CAD)

The first six rows of raw data is shown in the Table1. (Table \@ref(tab:rowdata))
```{r rowdata, echo=FALSE}
#plot row data set in table
  head(simulated_data)%>%
  select(-size)%>%
  kableExtra::kbl(caption = "First 6 rows Raw data ") %>%
  kableExtra::kable_styling(latex_options = "scale_down")%>% # use scale_down option to make the font
  kable_styling()
```
### EDA

Taking a deep look at all the features from survey questionnaire, we learned some demographic features about the restaurants in GTA:

* From figure1(Figure \@ref(fig:restaurant1)) and figure2(Figure \@ref(fig:restaurant2)), we noticed that more restaurants are located in Toronto (around 500) and Peel (around 400). The number of restaurants in Hilton is similar to the number in Durham. Meanwhile, Casual dining takes the lead in the restaurant type in GTA, with around 26%. Then it comes to Family style restaurant, accounting for 20%. Fast food restaurant, fine dining restaurant and Premium casual restaurant almost equally make up 10%.
There is no big difference between treated group and control group in terms of restaurant number and type distributions.


```{r restaurant1, fig.cap = "Restaurant numbers and types", echo=FALSE,fig.width=8, fig.height=5}
R1<-simulated_data%>%
  ggplot(aes(x = simulated_data$Q2,fill = type)) +
  geom_bar(stat = "count", position = "dodge") +
  labs(title = "More restuarants are loacted in City of Toronto and Peel Region",x="Regions") +
  theme_minimal() +
  scale_fill_manual(values = c("#E85C34", "#2C92D5"))

R2<-simulated_data%>%
  ggplot(aes(x = simulated_data$Q3 ,fill = type)) +
  geom_bar(stat = "count", position = "dodge") +
  labs(title = "More restuarants in GTA are casual dinning ",x="Regions") +
  theme_minimal() +
  scale_fill_manual(values = c("#E85C34", "#2C92D5"))

# combine two diagram in one graph
ggarrange(
  R1,R2,
  ncol = 1, nrow = 2,
  vjust = 1,
  widths = c(2, 2),
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  )

```


```{r restaurant2, fig.cap = "Restaurant types", echo=FALSE,fig.width=12, fig.height=4}

library(viridisLite)

# Treated group
rt1<-
  ggplot(treated_data, aes(fill= Q3, x= Q2)) +
  geom_bar(position="stack", stat="count")+
    ggtitle("Treated Group: Restaurant Types") +
    xlab("Regions")+
    ylab("Count of Numbers")+
    theme_grey()

    
rt1<- rt1 + guides(fill=guide_legend(title="Types")) # change the Legend title 

# Control group
rt2<-
  ggplot(control_data, aes(fill= Q3, x= Q2)) +
  geom_bar(position="stack", stat="count")+
    ggtitle("Control Group: Restaurant Types") +
    xlab("Regions")+
    ylab("Count of Numbers")+
    theme_grey()
    
rt2<- rt2 + guides(fill=guide_legend(title="Types")) # change the Legend title 
# combine two diagram in one graph
ggarrange(
  rt1, rt2, 
  ncol = 2, nrow = 1,
  vjust = 1,
  widths = c(2, 2),
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  )

```

* In terms of employees salary, the average hourly rate before and after intervention is both around 17 CAD. In contrast with two boxplots, we can see there is a slight increase in the treated group. The reason behind might because the employee take more risks to go for work, accordingly they will receive higher salary.  (Figure \@ref(fig:salary))  


```{r salary, fig.cap = "Employee salary distribution",echo=FALSE, fig.width=10, fig.height=4}
library(ggthemes)
# Treated group
s1<-
  ggplot(treated_data, aes(x = Q2, y= Q9)) +
  geom_boxplot(outlier.colour="red", 
               outlier.shape=5,
               outlier.size=4) +
  labs(title="Salary Distributions in Treated Group", x="Regions", y="Hourly rate")+
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.01, binwidth =1)+ # add dots
  theme_economist()

# Control group
s2<-
  ggplot(control_data, aes(x = Q2, y= Q9)) +
  geom_boxplot(outlier.colour="red", 
               outlier.shape=5,
               outlier.size=4)+
  labs(title="Salary Distributions in Control Group", x="Regions", y="Hourly rate")+
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.01,binwidth =1)+ #add dots
  theme_economist()


# combine two diagram in one graph

library(ggpubr)
ggarrange(
  s1, s2, 
  ncol = 2, nrow = 1,
  hjust = -0.5,
  align = "hv"
  )

```


* The attributes of the restaurant determine its management mode, so whether the restaurant is a franchise is quite important factor. From the pie charts, we found the portion of franchise rate in treated group is slightly lower than control group. We assume in treated group, the branch franchise restaurants should follow the rules by the head office. Considering the potential cost of COVID issues, chain restaurants will face greater risks, which is why they are less likely to be in the treated group.
(Figure \@ref(fig:pie1))


```{r pie1, fig.cap = "Restaurant franchise distribution", echo=FALSE, fig.width=10, fig.height=4}

Pie1<-control_data%>%
  ggplot(aes(x = control_data$Q4 ,fill = Q4)) +
  geom_bar(stat = "count", position = "dodge") +
  coord_polar("y", start=0)+   #Create a pie chart based on the barplot
  labs(title = "Franchise restaurants slightly decrease in treated group ",x="Regions",y="Count in control group") +
  theme_minimal() +
  scale_fill_manual(values = c("#E85C34", "#2C92D5"))

Pie2<-treated_data%>%
  ggplot(aes(x = treated_data$Q4 ,fill = Q4)) +
  geom_bar(stat = "count", position = "dodge") +
  coord_polar("y", start=0)+
  labs(title = "",x="Regions", y="Count in treated group") +
  theme_minimal() +
  scale_fill_manual(values = c("#E85C34", "#2C92D5"))

#Merge twp graphs
ggarrange(
  Pie1, Pie2, 
  ncol = 2, nrow = 1,
  hjust = -0.5,
  align = "hv"
  )
```
* The polar chart illustrates the employee numbers distribution, as can be seen in figure below. (Figure \@ref(fig:employee)) Because of COVID rule, no restaurant is allowed to open for large group dine in. So in the control group, there is 0 restaurant which has more than 30 employees. Most of restaurant has 10 to 20 employees. 

```{r employee, fig.cap = "Empoyee numbers distribution",echo=FALSE, fig.width=10, fig.height=4}
cxc <- 
  simulated_data%>%
  ggplot(aes(x = simulated_data$Q8 ,fill = type)) +
  geom_bar(width = 0.7,position = "dodge") + 
  coord_polar()+
  scale_fill_manual(values = c("#E85C34", "#2C92D5"))+
  labs(title = "Almost 0 restaurant has more than 30 employees in control group",x="", y="Count") +
  theme_minimal()

cxc
```




### T-Test
The T Test is used to compare the sample mean of our Treated group and Control group. The goal is to determine whether the intervention has an effective effect on the treated group. Our hypothesis is the intervention will have positive impact towards the restaurant's revenue. [@kim2015t] The T test results is represented in the Table2(Table \@ref(tab:ttest)). The package **Broom**[@broom1] is used to clean the t test results and convert it into the dataframe. The p value we get is < 2.2e-16, as the p value would indicate a significant result, meaning that the actual p value is even smaller than 2.2e-16 (a typical threshold is 0.05, anything smaller counts as statistically significant).[@kim2015t] So we can 
interpret hypothesis not rejected which means the intervention has a significant effect on treated group.

```{r ttest, echo=FALSE}
#install.packages("broom")
library(broom)
revenue_c <- control_data$Q13
revenue_t <- treated_data$Q13
t<-t.test(revenue_t, revenue_c)
m<-tidy(t, digits=1)
m%>%
  select(-c(estimate,statistic,parameter))%>%
  rename(
    mean_of_Treated=estimate1,
    mean_of_Control=estimate2
  )%>%
  kableExtra::kbl(caption = "T Test on the Restaurant's revenue") %>%
  kableExtra::kable_styling(latex_options = "scale_down")%>% # use scale_down option to make the font
  kable_styling()
  
```

### Correlation matrix
Correlation matrix shows internal relationships between x variables and y variable. (Figure \@ref(fig:correlation)) Intensity is indicated by the color(from red to blue). No significant coeffiency   is barred with symbol "x". More detailed analysis will be conducted in finding part. 

```{r correlation, fig.cap = "Correlation matrix",echo=FALSE, fig.width=10, fig.height=10}
#install.packages("fastDummies")
library(fastDummies)
Dummy_data<-simulated_data[-c(1,2)] #Remove Type and postcode columns

Dummy_data<- fastDummies::dummy_cols(Dummy_data) #  change categorical var to factors 

# correlation matrix for restaurants in treated group
Dummy_data<-Dummy_data[-c(1:3,5:7,9:11,13,44)] # remove big restaurant, cause it will always has -1 relationship with small restaurant


# Compute a correlation matrix
corr <- round(cor(Dummy_data), 1) # round to 1 digit

# Compute a matrix of correlation p-values
#install.packages("ggcorrplot")
library(ggcorrplot)
p.mat <- cor_pmat(Dummy_data)

# Visualize the lower triangle of the correlation matrix
# Barring the no significant coefficient
ggcorrplot(
  corr, hc.order = TRUE, type = "lower",
  p.mat=p.mat,
  title = "Correlation Matrix"
  )

```


```{r salary_distribution, echo=FALSE}
ggplot(simulated_data, aes(x = simulated_data$Q9, fill=type)) +
  geom_histogram(position = "dodge", bins = 30,binwidth = 0.5) +
  scale_fill_manual(values = c("#E85C34", "#2C92D5"))+
  labs(title="The Salary Distributions was higher for Teatment Group", x="Salary", y="Number of employee")+
  geom_density()

```






# Discussion

## Overview 

## Findings 

### Finding ONE

### Finding TWO
Invention effect on Flex and fiexed cost 

```{r felx_fix, fig.cap = "Invention effect on Flex and fiexed cost",echo=FALSE, fig.width=6, fig.height=4}
# Treated group

# Fixed costs 
fixc1<-
  ggplot(simulated_data, aes(fill= type, x=Q11)) +
  geom_bar(stat="count", width = 0.6,position = "dodge")+
  scale_fill_manual(values = c("#E85C34", "#2C92D5"))+
    ggtitle("Fixed costs increased in treated group and remain same in control group") +
    coord_flip()+
    xlab("Changes")+
    ylab("Number of restaurants")+
    theme_minimal()
fixc1<- fixc1 + guides(fill=guide_legend(title="Changes")) # change the Legend title 

# flex cost
flexc1<-
    ggplot(simulated_data, aes(fill= type, x=Q12)) +
    geom_bar(stat="count", width = 0.7, position = "dodge")+
    scale_fill_manual(values = c("#E85C34", "#2C92D5"))+
    ggtitle("Flexible costs increased in most of treated group restaurants") +
    coord_flip()+
    xlab("Changes")+
    ylab("Number of restaurants")+
    theme_minimal()
flexc1<- flexc1 + guides(fill=guide_legend(title="Changes")) # change the Legend title 



# combine two diagram in one graph
ggarrange(
  flexc1,fixc1,
  ncol = 1, nrow = 2,
  vjust = 1,
  widths = c(2, 2),
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  )

```
### Finding THREE
Invention effect on Revenue distributions 

```{r revenue_distribution, fig.cap="Invention effect on Revenue distributions",echo=FALSE}

library(ggthemes)
# Treated group
rd1<-
  ggplot(simulated_data, aes(x = simulated_data$Q13/1000, fill=type)) +
  geom_histogram(position = "dodge", bins = 30,binwidth = 5) +
  scale_fill_manual(values = c("#E85C34", "#2C92D5"))+
  labs(title="Revenue Distributions Move to the right", x="Renvenue (Thousands)", y="Count")+
  geom_density()+
  theme_calc()

rd1

```
## Limitation

## Future Directions 

```{r}

```

\newpage
# Appendix

## Appendix A
```{r AppendixA, message=FALSE, echo = FALSE}
### Number in GTA ### 
number_of_Toronto = 7500
number_of_Durham = 3260
number_of_York = 5553
number_of_Peel = 6235
number_of_Halton = 2803
number_of_GTA = sum(number_of_Toronto,number_of_Durham,number_of_York,number_of_Peel,number_of_Halton)

### Proportion ###
proportion_Toronto = (number_of_Toronto/number_of_GTA*100) 
proportion_Durham = (number_of_Durham/number_of_GTA*100)
proportion_York = (number_of_York/number_of_GTA*100)
proportion_Peel = (number_of_Peel/number_of_GTA*100)
proportion_Halton = (number_of_Halton/number_of_GTA*100)
Proportion_GTA = (number_of_GTA /number_of_GTA*100)

### Number of Sample ###
number_of_sample = 1637

sample_Toronto =proportion_Toronto*number_of_sample
sample_Durham =proportion_Durham *number_of_sample
sample_York =proportion_York*number_of_sample
sample_Peel =proportion_Peel*number_of_sample
sample_Halton =proportion_Halton *number_of_sample

### Dataframe ###
sample_size <- data.frame(
  Region = c ("Toronto", "Durham" , "York" , "Peel" , "Halton","Total"),
  Number_of_Region = c (number_of_Toronto,number_of_Durham,number_of_York,number_of_Peel,number_of_Halton,number_of_GTA),
  Proportion_of_Region= c (proportion_Toronto,proportion_Durham,proportion_York,proportion_Peel,proportion_Halton,Proportion_GTA)%>% round(digits = 2),
  Sample_of_Region = c (sample_Toronto,sample_Durham,sample_York ,sample_Peel,sample_Halton,number_of_sample) %>% round(digits = 0)
  )
  
### Table ###
library(kableExtra)
sample_size %>% 
  knitr::kable(caption = "Detailed information for stratification",
               col.names = c("Region", "Number of Restuarants", "Proportion(%)", "Sample Selected"))%>%
  kable_styling()
```

## Appendix B
```{r AppendixB, message=FALSE, echo = FALSE}
### basic information ###
number_of_survey = 3454
number_of_consent = 11325

print_cost_per_page = 0.05 
envelope_cost = 0.15
one_way_stamp = 0.55

### Calculation ###

total_print_cost = print_cost_per_page* (number_of_consent+number_of_survey)
total_envelope_cost = (number_of_consent+number_of_survey)*envelope_cost*2
total_stamp_cost =(number_of_consent+number_of_survey)*one_way_stamp*2

total_cost = total_print_cost+total_envelope_cost+total_stamp_cost

### dataframe ###
estimated_cost <- data.frame(
  Components = c ("Printing Cost", "Envelope Cost", "Stamp Cost"),
  Cost_per_unit= c (print_cost_per_page,envelope_cost,one_way_stamp),
  Total_cost_of_each_component  = c (total_print_cost, total_envelope_cost, total_stamp_cost)
)

### Table  ###
library(kableExtra)
estimated_cost %>% 
  knitr::kable(caption = "Estimated Cost",
               col.names = c("Components", "Cost per unit", "Total cost for each component"))%>%
  kable_styling()


```



\newpage

# References
